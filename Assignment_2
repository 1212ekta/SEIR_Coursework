'''Count the frequency of every word (a word is a sequence of alphanumeric characters, case does NOT matter) in the body of your document
Write a 64 bit hash function for a word using polynomial rolling hash function
Here s[i] is the ASCII for letter i in a word, use p = 53 and m = 264
Compute Simhash for the document 
Modify your program to take two URLs from the web on the command line, print how many bits are common in their simhashes.'''

import sys
import requests
from bs4 import BeautifulSoup
import re

#take  two urls in command line
def web_url():
    if len(sys.argv) < 3:#provide two url's
        print("Argument is None ,please provide it with two URL's")
        sys.exit()  #stop the program prevent from code creashing
    else:
        link1 = sys.argv[1]
        link2 = sys.argv[2]

        if not link1.startswith("http") or not link2.startswith("http"):#secured link
            print("Not an authentic url")
            sys.exit()

    return link1, link2

def retreive_page(link):    #it downloads the content of html
    try:
        headers = {"User-Agent": "Mozilla/5.0"}                                   #request to the server as a browser
        server_response = requests.get(link, headers=headers)
    except requests.exceptions.RequestException as e:
        print("error in page loading:", e)
        sys.exit()

    if server_response.status_code != 200:  #200 means page found and everything is ok 
        print("not able to fetch the page")
        sys.exit()

    return server_response.text

def page_html(html_content):
    parsed_cont = BeautifulSoup(html_content, "html.parser")#it extracts the html content by using web scraper 
    return parsed_cont

def retreive_body(parsed_doc):
    if parsed_doc.body:
        for tag in parsed_doc(["script","style"]): #for removing javascript ,css,hidden content
            tag.decompose()

        visible_text = parsed_doc.body.get_text(separator="\n", strip=True)
        return visible_text
    return ""

def count_word_freq(text):
    text = text.lower()
    words = re.findall(r'[a-z0-9]+', text) #it will add the valid alphanumeric character

    freq_count = {}#datastructure which stores the word as key and freq as value
    for word in words:
        freq_count[word] = freq_count.get(word, 0) + 1

    return freq_count

def hash64bit(word):
    p = 53
    m = 2**64 #this number fits in unsigned 64 bit integer space 
    hash_score = 0
    
    for element in word:
        hash_score = (hash_score*p + ord(element) ) % m  #polynomial rolling hash method
        

    return hash_score

def compute_simhash(freq_count): #simhash is use to detect similar documents quickly
    bit_weights = [0] * 64  #store 64bit

    for word in freq_count:
        word_hash = hash64bit(word)

        for i in range(64):
            if (word_hash >> i) & 1:#right shift word hash value ith times
                bit_weights[i] += freq_count[word]
            else:
                bit_weights[i] -= freq_count[word]

    simhash = 0
    for i in range(64):
        if bit_weights[i] > 0:
            simhash |= (1 << i)

    return simhash

def main():
    print("Execution of program is done")

    link1, link2 = web_url()
    html1 = retreive_page(link1)
    soup1 = page_html(html1)
    body1 = retreive_body(soup1)
    freq1 = count_word_freq(body1)
    simhash1 = compute_simhash(freq1)

    html2 = retreive_page(link2)
    soup2 = page_html(html2)
    body2 = retreive_body(soup2)
    freq2 = count_word_freq(body2)
    simhash2 = compute_simhash(freq2)

    xor = simhash1 ^ simhash2   # for duplicate detection
    different_bits = bin(xor).count("1")#if same bits return 0 else return 1
    common_bits = 64 - different_bits

    print("\nSimHash URL1:", format(simhash1,'064b')) #for binary representation of simhash1 value
    print("SimHash url2:", format(simhash2,'064b'))#for binary representation of simhash2 value
    print("Common bits in two url:", common_bits)#show similarity in both the url
    #take two urls in command line as python.py 1st_url 2nd_url

if __name__ == "__main__":
    main()
